---
- name: Prepare Environment on EC2
  hosts: frontend  # Ensure this matches the inventory group
  tasks:
    - name: Install Git
      apt:
        name: git
        state: present
      become: yes

    - name: Add GitHub to known hosts
      shell: echo "github.com $(ssh-keyscan -H github.com)" >> /home/ubuntu/.ssh/known_hosts
      args:
        executable: /bin/bash
      become: yes
      become_user: ubuntu

    - name: Create directory for frontend application
      file:
        path: /home/ubuntu/frontend-task
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Clone project from GitHub
      git:
        repo: "{{ git_repo }}"
        dest: /home/ubuntu/frontend-task/my-cv-application
        version: main
      vars:
        git_repo: git@github.com:Ahmed3019/my-cv-application.git

    - name: Wait for 60 seconds after cloning the project
      pause:
        seconds: 60

    - name: Install Docker
      apt:
        name: docker.io
        state: present
      become: yes

    - name: Install Docker Compose
      apt:
        name: docker-compose
        state: present
      become: yes

    - name: Pull latest Docker image
      docker_image:
        name: ahmedsalama3014/frontend-task
        tag: latest
        source: pull

    - name: Wait for 60 seconds after pulling Docker image
      pause:
        seconds: 60

    - name: Run Docker container
      docker_container:
        name: frontend-task
        image: ahmedsalama3014/frontend-task:latest
        state: started
        restart_policy: always
        published_ports:
          - "8020:80"  # Replace 80 with the internal port if different

    - name: Print message when container is running
      debug:
        msg: "Container '{{ docker_image_name }}' is running as '{{ docker_container_name }}'"
      vars:
        docker_image_name: "ahmedsalama3014/frontend-task:latest"
        docker_container_name: "frontend-task"
